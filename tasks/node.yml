- name: check nvm is installed
  shell: command -v nvm
  register: nvim_exists
  ignore_errors: true
  tags:
    - install
    - node

- name: install node version manager
  when: nvim_exists is failed
  shell: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
  args:
    creates: "{{ lookup('env', 'HOME') }}/.nvm/nvm.sh"
  tags:
    - install
    - node

- name: copy nvim dir
  when: ssh_initialized is failed
  copy: 
    src: "/root/.nvm"
    dest: "{{ lookup('env', 'HOME') }}/.nvm"
    owner: "{{ lookup('env', 'USER') }}"
    group: "{{ lookup('env', 'USER') }}"
  tags: 
    - install
    - node

- name: remove nvim dir from root
  shell: rm -rf /root/.nvim
  become_user: root
  tags: 
    - install
    - node

- name: copy bashrc
  when: ssh_initialized is failed
  copy: 
    src: "/root/.bashrc"
    dest: "{{ lookup('env', 'HOME') }}/.bashrc"
    owner: "{{ lookup('env', 'USER') }}"
    group: "{{ lookup('env', 'USER') }}"
  tags: 
    - install
    - node

- name: install node lts
  shell: "source {{ lookup('env', 'HOME') }}/.bashrc && nvm install --lts"
  tags: 
    - install
    - node

- name: install node neovim plugins
  shell: "source {{ lookup('env', 'HOME') }}/.bashrc && npm i -g neovim tree-sitter-cli prettier @johnnymorganz/stylua-bin tsc"
  tags:
    - install
    - node
